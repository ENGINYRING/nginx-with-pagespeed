# PageSpeed Configuration Example
# Place this file in /etc/nginx/conf.d/ or include it in your server block
# For more information: https://developers.google.com/speed/pagespeed/module/

# Enable PageSpeed
pagespeed on;

# Set the cache directory (must be writable by nginx user)
pagespeed FileCachePath /var/cache/ngx_pagespeed/;

# Set cache size limits
pagespeed FileCacheSizeKb 102400;
pagespeed FileCacheCleanIntervalMs 3600000;
pagespeed FileCacheInodeLimit 500000;

# Basic Optimization Filters
pagespeed EnableFilters rewrite_css;
pagespeed EnableFilters rewrite_javascript;
pagespeed EnableFilters rewrite_images;
pagespeed EnableFilters collapse_whitespace;
pagespeed EnableFilters remove_comments;

# Advanced CSS Optimization
pagespeed EnableFilters combine_css;
pagespeed EnableFilters move_css_to_head;
pagespeed EnableFilters move_css_above_scripts;
pagespeed EnableFilters fallback_rewrite_css_urls;
pagespeed EnableFilters prioritize_critical_css;

# JavaScript Optimization  
pagespeed EnableFilters combine_javascript;
pagespeed EnableFilters defer_javascript;
pagespeed EnableFilters canonicalize_javascript_libraries;

# Image Optimization
pagespeed EnableFilters convert_png_to_jpeg;
pagespeed EnableFilters convert_jpeg_to_webp;
pagespeed EnableFilters convert_to_webp_lossless;
pagespeed EnableFilters insert_image_dimensions;
pagespeed EnableFilters inline_images;
pagespeed EnableFilters lazyload_images;
pagespeed EnableFilters resize_images;
pagespeed EnableFilters recompress_images;

# HTML Optimization
pagespeed EnableFilters remove_quotes;
pagespeed EnableFilters trim_urls;
pagespeed EnableFilters elide_attributes;

# Resource Optimization
pagespeed EnableFilters extend_cache;
pagespeed EnableFilters extend_cache_css;
pagespeed EnableFilters extend_cache_images;
pagespeed EnableFilters extend_cache_scripts;

# Performance Optimizations
pagespeed EnableFilters sprite_images;
pagespeed EnableFilters inline_css;
pagespeed EnableFilters inline_javascript;
pagespeed EnableFilters flatten_css_imports;

# Cache Control
pagespeed ImplicitCacheTtlMs 300000;
pagespeed PreserveUrlRelativity on;

# PageSpeed-specific headers
pagespeed XHeaderValue "Powered By ngx_pagespeed";

# Admin and Statistics Pages
# Restrict access to these pages appropriately
location /ngx_pagespeed_statistics {
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 192.168.0.0/16;
    allow 172.16.0.0/12;
    deny all;
}

location /ngx_pagespeed_global_statistics {
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 192.168.0.0/16;
    allow 172.16.0.0/12;
    deny all;
}

location /pagespeed_admin {
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 192.168.0.0/16;
    allow 172.16.0.0/12;
    deny all;
}

location /pagespeed_console {
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 192.168.0.0/16;
    allow 172.16.0.0/12;
    deny all;
}

# Ensure PageSpeed doesn't break important files
location ~ "\.pagespeed\.([a-z]\.)?[a-z]{2}\.[^.]{10}\.[^.]+" {
    add_header "" "";
}

location ~ "^/pagespeed_static/" { }
location ~ "^/ngx_pagespeed_beacon$" { }

# Optional: Disable PageSpeed for specific file types or locations
# location ~* \.(pdf|zip|tar)$ {
#     pagespeed off;
# }

# Optional: Domain-specific configurations
# pagespeed Domain example.com;
# pagespeed MapRewriteDomain cdn.example.com example.com;

# Optional: Enable logging for debugging
# pagespeed LogDir /var/log/pagespeed;
# pagespeed MessageBufferSize 100000;
